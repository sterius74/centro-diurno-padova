
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Centro Diurno - Importazione Estesa</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <h2>Importa file Excel Utenti</h2>
    <input type="file" id="excel-file" accept=".xlsx,.xls" onchange="loadExcelFile(event)">
    <div id="users-table" style="margin-top: 30px;"></div>

    <script>
        
function log() {
    const div = document.getElementById('log');
    for (const a of arguments) {
        div.innerHTML += JSON.stringify(a) + ' ';
    }
    div.innerHTML += '<br>';
    console.log(...arguments);
}

const appData = { users: [] };

        
// Aggiunta supporto colonne: Pedane Laterali, Giorni, Turni, Priorità, Ordine Mattina/Pomeriggio
function loadExcelFile(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

            if (jsonData.length < 2) {
                alert('❌ Il file Excel deve contenere almeno una riga di dati oltre all'intestazione');
                return;
            }

            let startRow = 0;
            const firstRow = jsonData[0];
            if (firstRow && typeof firstRow[0] === 'string' && firstRow[0].toLowerCase().includes('nome')) {
                startRow = 1;
            }

            const newUsers = [];

            for (let i = startRow; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row || !row[0] || row[0].toString().trim() === '') continue;

                const name = row[0]?.toString().trim() || '';
                const address = row[1]?.toString().trim() || '';
                const phone = row[2]?.toString().trim() || '';
                const needsWheelchair = row[3]?.toString().toLowerCase().includes('s');
                const sideLift = row[4]?.toString().toLowerCase().includes('s');
                const days = row[5]?.toString().trim() || '';
                const shifts = row[6]?.toString().trim() || '';
                const priority = row[7]?.toString().trim() || 'Normale';
                const morningOrder = row[8]?.toString().trim().toLowerCase() || 'indifferente';
                const afternoonOrder = row[9]?.toString().trim().toLowerCase() || 'indifferente';

                const id = Date.now() + i;
                newUsers.push({
                    id,
                    name,
                    address,
                    phone,
                    needsWheelchair,
                    sideLift,
                    days,
                    shifts,
                    priority,
                    morningOrder,
                    afternoonOrder
                });
            }

            if (newUsers.length === 0) {
                alert('❌ Nessun utente valido trovato nel file.');
                return;
            }

            if (confirm(`Trovati ${newUsers.length} utenti. Vuoi sostituire quelli esistenti?`)) {
                appData.users = newUsers;
                renderSection();
                alert(`✅ Caricati ${newUsers.length} utenti da Excel!`);
            }

        } catch (error) {
            console.error('Errore Excel:', error);
            alert('❌ Errore lettura file Excel.');
        }
    };

    reader.readAsArrayBuffer(file);
    event.target.value = '';
}

        
// Funzione aggiornata: mostra tutte le info utenti estesi
function renderUsers() {
    const container = document.getElementById('users-table');
    container.innerHTML = `
        <table border="1" cellpadding="6">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Indirizzo</th>
                    <th>Telefono</th>
                    <th>Carrozzina</th>
                    <th>Pedana</th>
                    <th>Giorni</th>
                    <th>Turni</th>
                    <th>Priorità</th>
                    <th>Ordine Mattina</th>
                    <th>Ordine Pomeriggio</th>
                </tr>
            </thead>
            <tbody>
                ${appData.users.map(user => `
                    <tr>
                        <td>${user.name}</td>
                        <td>${user.address}</td>
                        <td>${user.phone}</td>
                        <td>${user.needsWheelchair ? 'Sì' : 'No'}</td>
                        <td>${user.sideLift ? 'Sì' : 'No'}</td>
                        <td>${user.days}</td>
                        <td>${user.shifts}</td>
                        <td>${user.priority}</td>
                        <td>${user.morningOrder}</td>
                        <td>${user.afternoonOrder}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

        // Ottimizzazione estesa: già presente ma non richiamata in questa demo semplice

        function renderSection() {
            renderUsers();
        }

        document.addEventListener("DOMContentLoaded", () => renderSection());
    </script>

<div id="log" style="margin-top:30px;font-family:monospace;color:#444"></div>
</body>
</html>
